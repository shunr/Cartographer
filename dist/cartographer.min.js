var Cartographer=function(){function o(){v=[],x=0,b="none",w=null,g&&(g.style.display="initial"),m.remove(),document.removeEventListener("mouseup",c),m.removeEventListener("mousedown",a),m.removeEventListener("mousemove",l)}function e(o,e){for(var t=-1;t<=1;t++)for(var n=-1;n<=1;n++)if(!E.isPointInPath(o+t,e+n,"evenodd"))return!1
return!0}function t(o,e,t,n){var r=v[x]
0==o.button&&x>=v.length&&(r=v[v.push({shape:n,coords:[{x:e,y:t},{x:e,y:t}]})-1],w=r.coords[1]),s()}function n(o,t,n){var a=v[x]
if(o.shiftKey&&0==o.button){x>=v.length&&(a=v[v.push({shape:"poly",coords:[]})-1]),a.coords.push({x:t,y:n}),d(a)
for(i in a.coords)e(a.coords[i].x,a.coords[i].y)&&a.coords.splice(i,1)}else 2==o.button&&a&&a.coords.length>3&&r(a,t,n,function(o){a.coords.splice(o,1)})
s()}function r(o,e,t,n){for(var r=o.coords.length-1;r>=0;r--)if(u(o.coords[r].x,o.coords[r].y,e,t)<=y+1)return n(r)}function s(){E.clearRect(0,0,m.width,m.height),E.drawImage(g,0,0,m.width,m.height)
for(var o=0;o<v.length;o++)h(v[o],o==x?1:.5)}function a(o){var s=o.offsetX,a=o.offsetY
if("poly"==b||v[x]&&"poly"==v[x].shape?n(o,s,a):"rect"!=b&&"circle"!=b||t(o,s,a,b),v[x]&&r(v[x],s,a,function(o){w=v[x].coords[o]}),0==o.button&&0==o.shiftKey&&v.length>0&&!w){b="none",x>=v.length&&(x=Math.max(v.length-1,0))
for(var i=v.length-1;i>=0;i--){if(d(v[i]),e(s,a)){x=i
break}r(v[i],s,a,function(){x=i})}}}function c(o){w=null}function l(o){var e=o.offsetX,t=o.offsetY
if(m.style.cursor="default",v.length>x&&(r(v[x],e,t,function(o){m.style.cursor="all-scroll"}),w)){var n,a=v[x].coords.indexOf(w)
2==v[x].coords.length&&(n=0==a?v[x].coords[1]:v[x].coords[0]),o.shiftKey&&n&&(n.x+=e-w.x,n.y+=t-w.y),w.x=e,w.y=t}s()}function d(o){if(o.coords)if("poly"==o.shape){E.beginPath(),E.moveTo(o.coords.last().x,o.coords.last().y)
for(i in o.coords)E.lineTo(o.coords[i].x,o.coords[i].y)
E.closePath()}else"rect"==o.shape?(E.beginPath(),E.rect(o.coords[0].x,o.coords[0].y,o.coords[1].x-o.coords[0].x,o.coords[1].y-o.coords[0].y),E.closePath()):"circle"==o.shape&&(E.beginPath(),E.arc(o.coords[0].x,o.coords[0].y,u(o.coords[0].x,o.coords[0].y,o.coords[1].x,o.coords[1].y),0,2*Math.PI,!0),E.closePath())}function h(o,e){if(E.save(),e||(e=1),E.globalAlpha=e,E.globalCompositeOperation="luminosity",E.fillStyle="rgba(255,255,255,0.3)",E.strokeStyle="rgba(240,240,240,1)",E.shadowColor="black",E.lineWidth=3,d(o),E.fill("evenodd"),E.shadowBlur=8,E.stroke(),E.fillStyle="white",o.coords.length>0)for(i in o.coords)E.beginPath(),E.arc(o.coords[i].x,o.coords[i].y,y,0,2*Math.PI,!0),E.fill()
E.restore()}function u(o,e,t,n){return Math.sqrt(Math.pow(o-t,2)+Math.pow(e-n,2))}function f(o,e){o.parentNode.insertBefore(e,o.nextSibling)}function p(o,e){var t
for(t in e)e.hasOwnProperty(t)&&(o[t]=e[t])
return o}var y,g,m,v,x,w,b,P={},m=document.createElement("canvas"),E=m.getContext("2d"),I={imageId:"",handleRadius:4,mapId:""}
return P.launch=function(){o()
var e={}
arguments[0]&&"object"==typeof arguments[0]&&(e=p(I,arguments[0])),y=e.handleRadius,g=document.getElementById(e.imageId),m.style.cssText=window.getComputedStyle(g).cssText,m.height=g.height,m.width=g.width,E.drawImage(g,0,0),g.style.display="none",f(g,m),P.importMap(e.mapId),document.addEventListener("mouseup",c),m.addEventListener("mousedown",a),m.addEventListener("mousemove",l),m.addEventListener("contextmenu",function(o){o.preventDefault()},!1)},P.stop=function(){o()},P.newShape=function(o){b=o,x<v.length&&(x=v.length),s()},P.deleteShape=function(){b="none",x<v.length&&v.splice(x,1),x=Math.max(v.length-1,0),s()},P.importMap=function(o){if(el=document.getElementById(o),el){v=[],x=0,b="none",w=null,areas=el.getElementsByTagName("area")
for(var e=0;e<areas.length;e++){shape={coords:[]},shape.shape=areas[e].shape
for(var t=areas[e].coords.split(","),n=0;n<t.length;n+=2)shape.coords.push({x:t[n],y:t[n+1]})
v.push(shape)}s()}},P.exportMap=function(o){var e=[]
if("map"==o)for(var t=0;t<v.length;t++){for(var n="",r=0;r<v[t].coords.length;r++)n+=v[t].coords[r].x+","+v[t].coords[r].y+(r<v[t].coords.length-1?",":"")
e.push("<area shape='"+v[t].shape+"' coords='"+n+"'>")}else"json"!=o&&o||(e=v)
return e},Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),P}()
